import express from "express";
import bodyParser from "body-parser";
import cors from "cors";
import jwt from "jsonwebtoken";
import bcrypt from "bcrypt";
import multer from "multer";
import sqlite3 from "sqlite3";
import { open } from "sqlite";
import path from "path";
import { fileURLToPath } from "url";
import fs from "fs";
import paypal from "@paypal/checkout-server-sdk";

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);
const app = express();
const PORT = process.env.PORT || 3000;
const JWT_SECRET = process.env.JWT_SECRET || "dark_secret";

// === Middlewares ===
app.use(cors());
app.use(bodyParser.json());
app.use("/uploads", express.static(path.join(__dirname, "uploads")));

// === Database ===
let db;
(async () => {
  db = await open({
    filename: "./database.sqlite",
    driver: sqlite3.Database,
  });

  await db.exec(`
    CREATE TABLE IF NOT EXISTS users (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      username TEXT UNIQUE,
      email TEXT UNIQUE,
      password TEXT,
      role TEXT DEFAULT 'user',
      about TEXT,
      banned INTEGER DEFAULT 0,
      avatar TEXT DEFAULT 'uploads/avatars/default.png'
    );

    CREATE TABLE IF NOT EXISTS files (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      name TEXT,
      category TEXT,
      path TEXT,
      uploadedBy INTEGER,
      price REAL DEFAULT 0,
      createdAt TEXT DEFAULT CURRENT_TIMESTAMP,
      FOREIGN KEY(uploadedBy) REFERENCES users(id)
    );

    CREATE TABLE IF NOT EXISTS vip (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      userId INTEGER,
      active INTEGER DEFAULT 1,
      expiresAt TEXT,
      amount REAL DEFAULT 0,
      FOREIGN KEY(userId) REFERENCES users(id)
    );

    CREATE TABLE IF NOT EXISTS messages (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      type TEXT,
      content TEXT
    );

    CREATE TABLE IF NOT EXISTS chat (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      chatType TEXT,
      senderId INTEGER,
      receiverId INTEGER,
      content TEXT,
      createdAt TEXT DEFAULT CURRENT_TIMESTAMP,
      FOREIGN KEY(senderId) REFERENCES users(id),
      FOREIGN KEY(receiverId) REFERENCES users(id)
    );

    CREATE TABLE IF NOT EXISTS file_comments (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      fileId INTEGER,
      userId INTEGER,
      content TEXT,
      createdAt TEXT DEFAULT CURRENT_TIMESTAMP,
      FOREIGN KEY(fileId) REFERENCES files(id),
      FOREIGN KEY(userId) REFERENCES users(id)
    );

    CREATE TABLE IF NOT EXISTS file_likes (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      fileId INTEGER,
      userId INTEGER,
      createdAt TEXT DEFAULT CURRENT_TIMESTAMP,
      UNIQUE(fileId, userId),
      FOREIGN KEY(fileId) REFERENCES files(id),
      FOREIGN KEY(userId) REFERENCES users(id)
    );
  `);

  // –°–æ–∑–¥–∞—ë–º –∞–¥–º–∏–Ω–∞, –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
  const adminEmail = "juliaangelss26@gmail.com";
  const existingAdmin = await db.get("SELECT * FROM users WHERE email = ?", [adminEmail]);
  if (!existingAdmin) {
    const hashed = await bcrypt.hash("dark4884", 10);
    await db.run(
      "INSERT INTO users (username, email, password, role) VALUES (?, ?, ?, ?)",
      ["Admin", adminEmail, hashed, "admin"]
    );
    console.log("üëë –ê–¥–º–∏–Ω —Å–æ–∑–¥–∞–Ω");
  }

  // –î–æ–±–∞–≤–ª—è–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
  const defaultCat = await db.get("SELECT * FROM messages WHERE type = 'cat'");
  if (!defaultCat) {
    await db.run("INSERT INTO messages (type, content) VALUES (?, ?)", [
      "cat",
      "–ú—è—É! –Ø —Ç–≤–æ—è —Ç—ë–º–Ω–∞—è –ø–æ–º–æ—â–Ω–∏—Ü–∞ üêæ",
    ]);
  }
  const defaultBat = await db.get("SELECT * FROM messages WHERE type = 'bat'");
  if (!defaultBat) {
    await db.run("INSERT INTO messages (type, content) VALUES (?, ?)", [
      "bat",
      "–®—à—à... –ù–æ–≤–æ—Å—Ç–∏ –∏–∑ —Ç–µ–Ω–µ–π ü¶á",
    ]);
  }
})();

// === Middleware –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ç–æ–∫–µ–Ω–∞ ===
function authMiddleware(req, res, next) {
  const authHeader = req.headers["authorization"];
  if (!authHeader) return res.status(401).json({ error: "–ù–µ—Ç —Ç–æ–∫–µ–Ω–∞" });

  const token = authHeader.split(" ")[1];
  jwt.verify(token, JWT_SECRET, (err, user) => {
    if (err) return res.status(403).json({ error: "–ù–µ–≤–µ—Ä–Ω—ã–π —Ç–æ–∫–µ–Ω" });
    req.user = user;
    next();
  });
}

// === Multer –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∞–≤–∞—Ç–∞—Ä–æ–≤ ===
const avatarStorage = multer.diskStorage({
  destination: (req, file, cb) => {
    const dir = path.join(__dirname, "uploads", "avatars");
    if (!fs.existsSync(dir)) fs.mkdirSync(dir, { recursive: true });
    cb(null, dir);
  },
  filename: (req, file, cb) => cb(null, Date.now() + "-" + file.originalname),
});
const uploadAvatar = multer({ storage: avatarStorage });

// === Multer –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤ ===
const fileStorage = multer.diskStorage({
  destination: (req, file, cb) => {
    const type = req.query.type || "files";
    const dir = path.join(__dirname, "uploads", type);
    if (!fs.existsSync(dir)) fs.mkdirSync(dir, { recursive: true });
    cb(null, dir);
  },
  filename: (req, file, cb) => cb(null, Date.now() + "-" + file.originalname),
});
// === –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤ ===
app.post("/upload-file", authMiddleware, uploadFile.single("file"), async (req, res) => {
  try {
    if (!req.file) {
      return res.status(400).json({ error: "–§–∞–π–ª –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω" });
    }

    const { originalname, filename } = req.file;
    const { category, price } = req.body;

    const filePath = path.join("uploads", req.query.type || "files", filename);

    await db.run(
      "INSERT INTO files (name, category, path, uploadedBy, price) VALUES (?, ?, ?, ?, ?)",
      [originalname, category || "general", filePath, req.user.id, price || 0]
    );

    res.json({ success: true, file: { name: originalname, path: `/${filePath}` } });
  } catch (err) {
    console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞:", err);
    res.status(500).json({ error: "–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª" });
  }
});
const uploadFile = multer({ storage: fileStorage });

// === –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è ===
app.post("/register", async (req, res) => {
  const { username, email, password } = req.body;
  try {
    if (!username || !email || !password) {
      return res.status(400).json({ error: "–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è" });
    }
    const hashed = await bcrypt.hash(password, 10);
    await db.run(
      "INSERT INTO users (username, email, password) VALUES (?, ?, ?)",
      [username, email, hashed]
    );
    res.json({ success: true });
  } catch {
    res.status(400).json({ error: "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç" });
  }
});

// === –õ–æ–≥–∏–Ω ===
app.post("/login", async (req, res) => {
  const { email, password } = req.body;
  const user = await db.get("SELECT * FROM users WHERE email = ?", [email]);

  if (!user) return res.status(400).json({ error: "–ù–µ–≤–µ—Ä–Ω–∞—è –ø–æ—á—Ç–∞ –∏–ª–∏ –ø–∞—Ä–æ–ª—å" });
  if (user.banned) return res.status(403).json({ error: "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω" });

  const valid = await bcrypt.compare(password, user.password);
  if (!valid) return res.status(400).json({ error: "–ù–µ–≤–µ—Ä–Ω–∞—è –ø–æ—á—Ç–∞ –∏–ª–∏ –ø–∞—Ä–æ–ª—å" });

  const vip = await db.get("SELECT * FROM vip WHERE userId = ? AND active = 1", [user.id]);
  let role = user.role;
  if (user.email === "juliaangelss26@gmail.com") {
    role = "admin";
  } else if (vip && vip.amount >= 10) {
    role = "developer";
    await db.run("UPDATE users SET role = 'developer' WHERE id = ?", [user.id]);
  }

  const token = jwt.sign(
    { id: user.id, username: user.username, role },
    JWT_SECRET,
    { expiresIn: "2h" }
  );
  res.json({ token, role });
});

// === –ü—Ä–æ—Ñ–∏–ª—å ===
app.get("/profile", authMiddleware, async (req, res) => {
  let user = await db.get(
    "SELECT id, username, role, about, avatar, email FROM users WHERE id = ?",
    [req.user.id]
  );
  if (!user) return res.status(404).json({ error: "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω" });

  if (!fs.existsSync(path.join(__dirname, user.avatar))) {
    user.avatar = "uploads/avatars/default.png";
  }

  user.avatar = `/${user.avatar}`;
  res.json(user);
});

// === –ß–∞—Ç ===
app.get("/chat/:type", authMiddleware, async (req, res) => {
  try {
    const userId = req.user?.id;
    const chatType = req.params.type;

    if (!["global", "private"].includes(chatType)) {
      return res.status(400).json({ error: "–ù–µ–≤–µ—Ä–Ω—ã–π —Ç–∏–ø —á–∞—Ç–∞" });
    }

    let query = `
      SELECT chat.id, chat.content, chat.createdAt, 
             u.username, u.role
      FROM chat
      JOIN users u ON u.id = chat.senderId
    `;

    if (chatType === "private") {
      query += ` WHERE chat.receiverId = ? OR chat.senderId = ? ORDER BY chat.createdAt DESC LIMIT 50`;
      const messages = await db.all(query, [userId, userId]);
      return res.json(messages.reverse());
    } else {
      query += ` WHERE chat.chatType = 'global' ORDER BY chat.createdAt DESC LIMIT 50`;
      const messages = await db.all(query);
      return res.json(messages.reverse());
    }
  } catch (e) {
    console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —á–∞—Ç–∞:", e);
    res.status(500).json({ error: "–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞" });
  }
});

app.post("/chat/:type", authMiddleware, async (req, res) => {
  try {
    const userId = req.user?.id;
    const { content, receiverId } = req.body;
    const chatType = req.params.type;

    if (!content || content.length > 500) {
      return res.status(400).json({ error: "–°–æ–æ–±—â–µ–Ω–∏–µ –ø—É—Å—Ç–æ–µ –∏–ª–∏ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ–µ" });
    }

    if (chatType === "private" && !receiverId) {
      return res.status(400).json({ error: "–£–∫–∞–∂–∏—Ç–µ –ø–æ–ª—É—á–∞—Ç–µ–ª—è" });
    }

    await db.run(
      `INSERT INTO chat (chatType, senderId, receiverId, content) VALUES (?, ?, ?, ?)`,
      [chatType, userId, chatType === "private" ? receiverId : null, content]
    );

    res.json({ success: true });
  } catch (e) {
    console.error("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è:", e);
    res.status(500).json({ error: "–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞" });
  }
});

// === –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∫ —Ñ–∞–π–ª–∞–º ===
app.get("/files/:id/comments", async (req, res) => {
  try {
    const { id } = req.params;
    const comments = await db.all(
      `SELECT fc.id, fc.content, fc.createdAt, u.username 
       FROM file_comments fc
       JOIN users u ON u.id = fc.userId
       WHERE fc.fileId = ?
       ORDER BY fc.createdAt DESC`,
      [id]
    );
    res.json(comments);
  } catch {
    res.status(500).json({ error: "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤" });
  }
});

app.post("/files/:id/comments", authMiddleware, async (req, res) => {
  try {
    const { id } = req.params;
    const { content } = req.body;
    if (!content) return res.status(400).json({ error: "–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –ø—É—Å—Ç–æ–π" });

    await db.run(
      "INSERT INTO file_comments (fileId, userId, content) VALUES (?, ?, ?)",
      [id, req.user.id, content]
    );
    res.json({ success: true });
  } catch {
    res.status(500).json({ error: "–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è" });
  }
});

// === –õ–∞–π–∫–∏ ("–º—è—É–∫") ===
app.post("/files/:id/like", authMiddleware, async (req, res) => {
  try {
    const { id } = req.params;

    const existing = await db.get(
      "SELECT * FROM file_likes WHERE fileId = ? AND userId = ?",
      [id, req.user.id]
    );

    if (existing) {
      await db.run("DELETE FROM file_likes WHERE id = ?", [existing.id]);
      return res.json({ success: true, liked: false });
    } else {
      await db.run("INSERT INTO file_likes (fileId, userId) VALUES (?, ?)", [
        id,
        req.user.id,
      ]);
      return res.json({ success: true, liked: true });
    }
  } catch {
    res.status(500).json({ error: "–û—à–∏–±–∫–∞ –ª–∞–π–∫–∞" });
  }
});

app.get("/files/:id/likes", async (req, res) => {
  try {
    const { id } = req.params;
    const count = await db.get(
      "SELECT COUNT(*) as total FROM file_likes WHERE fileId = ?",
      [id]
    );
    res.json({ total: count.total });
  } catch {
    res.status(500).json({ error: "–û—à–∏–±–∫–∞ –ø–æ–¥—Å—á—ë—Ç–∞ –ª–∞–π–∫–æ–≤" });
  }
});

// === –ê–¥–º–∏–Ω–∫–∞: —Å–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤ ===
app.get("/admin/files", authMiddleware, async (req, res) => {
  if (req.user.role !== "admin") return res.status(403).json({ error: "–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω" });
  const files = await db.all("SELECT * FROM files ORDER BY createdAt DESC");
  res.json(files);
});

// === –ê–¥–º–∏–Ω–∫–∞: —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏ ===
app.get("/admin/messages", authMiddleware, async (req, res) => {
  if (req.user.role !== "admin") return res.status(403).json({ error: "–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω" });
  const msgs = await db.all("SELECT * FROM messages");
  res.json(msgs);
});

app.post("/admin/messages", authMiddleware, async (req, res) => {
  if (req.user.role !== "admin") return res.status(403).json({ error: "–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω" });
  const { type, content } = req.body;
  await db.run("INSERT INTO messages (type, content) VALUES (?, ?)", [type, content]);
  res.json({ success: true });
});

app.put("/admin/messages/:id", authMiddleware, async (req, res) => {
  if (req.user.role !== "admin") return res.status(403).json({ error: "–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω" });
  const { id } = req.params;
  const { content } = req.body;
  if (!content) return res.status(400).json({ error: "–¢–µ–∫—Å—Ç –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º" });

  await db.run("UPDATE messages SET content = ? WHERE id = ?", [content, id]);
  res.json({ success: true });
});

app.delete("/admin/messages/:id", authMiddleware, async (req, res) => {
  if (req.user.role !== "admin") return res.status(403).json({ error: "–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω" });
  const { id } = req.params;
  await db.run("DELETE FROM messages WHERE id = ?", [id]);
  res.json({ success: true });
});

// === –°–æ–æ–±—â–µ–Ω–∏—è (–∫–æ—à–∫–∞ –∏ –ª–µ—Ç—É—á–∞—è –º—ã—à—å) ===
app.get("/messages/:type", async (req, res) => {
  const { type } = req.params;
  const msg = await db.get("SELECT content FROM messages WHERE type = ? ORDER BY RANDOM() LIMIT 1", [type]);
  if (!msg) return res.json({ message: "–°–æ–æ–±—â–µ–Ω–∏–π –ø–æ–∫–∞ –Ω–µ—Ç." });
  res.json({ message: msg.content });
});

// === –°—Ç–∏–∫–µ—Ä—ã ===
app.get("/stickers", async (req, res) => {
  try {
    const stickersDir = path.join(__dirname, "uploads", "stickers");

    if (!fs.existsSync(stickersDir)) {
      return res.json([]);
    }

    const files = fs.readdirSync(stickersDir)
      .filter(file => /\.(png|jpg|jpeg|gif|webp)$/i.test(file));

    res.json(files.map(file => ({
      name: file,
      url: `/uploads/stickers/${file}`
    })));
  } catch (err) {
    console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç–∏–∫–µ—Ä–æ–≤:", err);
    res.status(500).json({ error: "–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç–∏–∫–µ—Ä—ã" });
  }
});

// === –°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π ===
app.get("/users", async (req, res) => {
  try {
    const users = await db.all("SELECT id, username FROM users WHERE banned = 0");
    res.json(users);
  } catch (err) {
    console.error("–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:", err);
    res.status(500).json({ error: "–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π" });
  }
});

// === PayPal Integration ===
const Environment = paypal.core.SandboxEnvironment;
const paypalClient = new paypal.core.PayPalHttpClient(
  new Environment(
    process.env.PAYPAL_CLIENT_ID || "AU9A6gbVWpQ5gu6oWT8alj1wMqgTUDqDM5bidlDBYujcispGUtVZkqFKGZ7rEpuT0FcGbMM8To7Kiv-6",
    process.env.PAYPAL_CLIENT_SECRET || "EFot3o0eLa_AtP69rmS_7InXZcm4dppF-cRjJFh10uXs51Tu58jVclVShzc50dXh9-mKmlCYQB7r-bM9"
  )
);

app.post("/create-order", authMiddleware, async (req, res) => {
  const { amount } = req.body;
  const request = new paypal.orders.OrdersCreateRequest();
  request.prefer("return=representation");
  request.requestBody({
    intent: "CAPTURE",
    purchase_units: [{ amount: { currency_code: "EUR", value: amount } }],
  });

  try {
    const order = await paypalClient.execute(request);
    res.json(order.result);
  } catch (err) {
    console.error(err);
    res.status(500).json({ error: "–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–∫–∞–∑–∞" });
  }
});

app.post("/capture-order", authMiddleware, async (req, res) => {
  const { orderID, days, amount } = req.body;
  const request = new paypal.orders.OrdersCaptureRequest(orderID);
  request.requestBody({});
  try {
    const capture = await paypalClient.execute(request);

    if (capture.result.status === "COMPLETED") {
      const expiresAt = new Date();
      expiresAt.setDate(expiresAt.getDate() + (days || 30));

      await db.run(
        "INSERT INTO vip (userId, expiresAt, amount) VALUES (?, ?, ?)",
        [req.user.id, expiresAt.toISOString(), amount]
      );

      if (amount >= 10) {
        await db.run("UPDATE users SET role = 'developer' WHERE id = ?", [req.user.id]);
      }

      res.json(capture.result);
    }
  } catch (err) {
    console.error(err);
    res.status(500).json({ error: "–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–∏ –ø–ª–∞—Ç–µ–∂–∞" });
  }
});
// === VIP –ø—Ä–æ–≤–µ—Ä–∫–∞ ===
app.get("/check-vip", authMiddleware, async (req, res) => {
  const vip = await db.get("SELECT * FROM vip WHERE userId = ? AND active = 1", [req.user.id]);
  if (!vip) return res.json({ vip: false });

  const now = new Date();
  if (new Date(vip.expiresAt) < now) {
    await db.run("UPDATE vip SET active = 0 WHERE id = ?", [vip.id]);
    return res.json({ vip: false });
  }
  res.json({ vip: true, expiresAt: vip.expiresAt, amount: vip.amount });
});

// === –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞ ===
app.listen(PORT, () => console.log(`üöÄ –°–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω –Ω–∞ –ø–æ—Ä—Ç—É ${PORT}`));
